function mostrar(){document.getElementById("contayuda").style.display="initial"}function ocultar(){document.getElementById("contayuda").style.display="none"}function cargaLibreria(a){libreriaDB.once("value",function(i){var e;e=0!==libreria.length?!1:!0;var o,r=i.val(),t=0;a.length=0;for(o in r)a[t]=r[o],a[t].iddb=o,a[t].indice=t,t++;e&&actualizar(libreria)})}function añadeIddb(a,i){libreriaDB.once("value").then(function(e){var o,r=e.val(),t=0;for(o in r)t===i&&(a[t].iddb=o),t++})}function cambioRemoto(a,i){var e=libreria[i];e.indice=i,e.isbn=a.isbn,e.titulo=a.titulo,e.autor=a.autor,e.anio=a.anio,e.editorial=a.editorial,e.iddb=a.key}function chequeaBotones(){var a=Boolean($(".seleccionado")[0]);0!==libreria.length&&a?($("#modificar").removeClass("disabled"),$("#quitar").removeClass("disabled"),$("#anadir").addClass("disabled"),$("#buscar").addClass("disabled")):($("#modificar").addClass("disabled"),$("#quitar").addClass("disabled"),$("#anadir").removeClass("disabled"),$("#buscar").removeClass("disabled"))}function pintarLinea(a){$("#tableta tbody").append('<tr class="linea" onclick="seleccionar(this);"><td>'+a.isbn+"</td><td>"+a.titulo+"</td><td>"+a.autor+"</td><td>"+a.anio+"</td><td>"+a.editorial+'</td><td class="sr-only">'+a.indice+"</td></tr>")}function actualizar(a){if(0!==a.length){var i;if($(".linea").remove(),$("#busqueda").text(""),$("#resultado").text(""),$("th").css("background-color","#B4C9CC"),a===libreria||busquedaactiva===!1){for(i in a)pintarLinea(a[i]);arraymostrado=JSON.parse(JSON.stringify(a)),numerodefilas=Object.size(arraymostrado),$("#tableta").jTPS({perPages:[porpagina]}),$(".stubCell").remove()}else if(busquedaactiva===!0){for(i in a)pintarLinea(a[i]);arraymostrado=JSON.parse(JSON.stringify(a)),numerodefilas=Object.size(arraymostrado),$("#tableta").jTPS({perPages:[porpagina]}),$(".stubCell").remove(),$("th").css("background-color","#66ffb3"),$("#busqueda").text("Resultados de la búsqueda")}limpiaForm()}else $(".linea").remove();chequeaBotones()}function calculaIsbn10(a){var i,e,o=0;for(e=a.toLowerCase(),i=0;i<e.length-1;i++)o+=Number(e[i])*(i+1);return o%=11,10==o&&(o="x"),o==e[e.length-1]?!0:!1}function calculaIsbn13(a){var i,e=0;for(i=1;12>=i;i+=2)e=e+3*Number(a[i])+Number(a[i-1]);return e=10-e%10,e==Number(a[a.length-1])?!0:!1}function contarNumeros(a){var i,e=a.length;return 10===e?i=calculaIsbn10(a):13===e&&(i=calculaIsbn13(a)),i}function compararisbn(a){for(var i=libreria.length,e=0,o=0;i>o;o++)if(libreria[o].isbn.toLowerCase()==a.toLowerCase()){e=1;break}return 1==e?($("#isbnnull").html("Ya existe una entrada con este ISBN"),arrmensajes[0]=" OBLIGATORIO: Ya existe una entrada con este ISBN",salida=!1,$("#isbn").css("border","1px solid red"),!1):!0}function validarIsbn(){var a,i="",e=/^\s*(?:\d{9}[0-9xX]{1}|\d{13})\s*?/g,o=$("#isbn").val().trim();return e.test(o)?(o.toLowerCase(),contarNumeros(o)?($("#isbn").css("border","1px solid black"),a=!0):(i=" OBLIGATORIO: ISBN inválido, nro. de control incorrecto",$("#isbn").css("border","2px solid red"),a=!1)):(formNoVacio()&&($("#isbn").css("border","2px solid red"),$("#isbn").css("border","2px solid red")),i=" OBLIGATORIO: Formato de ISBN inválido 10/13 dígitos",a=!1),formNoVacio()&&$("#isbnnull").html(i),arrmensajes[0]=i,a}function validarTitulo(){var a=/\w+/,i=$("#titulo").val().trim();return a.test(i)&&""!==i?($("#titulo").css("border","1px solid black"),$("#titulonull").html(""),arrmensajes[1]="",!0):(formNoVacio()&&($("#titulo").css("border","2px solid red"),$("#titulonull").html(" OBLIGATORIO: Título vacío")),arrmensajes[1]=" OBLIGATORIO: Título vacío",!1)}function validarAutor(){var a=$("#autor").val().trim();return""!==a?($("#autor").css("border","1px solid black"),$("#autornull").html(""),arrmensajes[2]="",!0):(formNoVacio()&&($("#autor").css("border","2px solid #a8410f"),$("#autornull").html(" Autor vacío")),arrmensajes[2]=" OPCIONAL: Autor vacío",!1)}function validarAnio(){var a=/\d{1,4}/,i=$("#anio").val().trim();return a.test(i)?($("#anio").css("border","1px solid black"),$("#anionull").html(""),arrmensajes[3]="",!0):(formNoVacio()&&($("#anio").css("border","2px solid #a8410f"),$("#anionull").html(" Año publ. incorrecto: 4 dígitos")),arrmensajes[3]=" OPCIONAL: Año publ. incorrecto: 4 dígitos",!1)}function validarEditorial(){var a=$("#editorial").val().trim();return""!==a?($("#editorial").css("border","1px solid black"),$("#editorialnull").html(""),arrmensajes[4]="",!0):(formNoVacio()&&($("#editorial").css("border","2px solid #a8410f"),$("#editorialnull").html(" Editorial vacía")),arrmensajes[4]=" OPCIONAL: Editorial vacía",!1)}function montaAlerta(){var a;if(alertmensaje="",0!==arrmensajes.length)for(a in arrmensajes)(""!==arrmensajes[a]||void 0!==arrmensajes[a])&&(alertmensaje+=arrmensajes[a]+"\n")}function validar(){var a,i,e,o,r,t={};return void 0===$("#oculto").val()?t.indice=Number(libreria.length):t.indice=Number($("#oculto").val()),a=validarIsbn(),t.isbn=a?$("#isbn").val():"",i=validarTitulo(),t.titulo=i?$("#titulo").val():"",e=validarAutor(),t.autor=e?$("#autor").val():"",o=validarAnio(),t.anio=o?Number($("#anio").val()):"",r=validarEditorial(),t.editorial=r?$("#editorial").val():"",t.iddb="",a&&i?t:null}function limpiaForm(){$("input").val(""),$("input").css("border","1px solid black"),$(".mensaje").html(""),$("tr").removeClass("seleccionado"),chequeaBotones(),arrmensajes.length=0}function objFormulario(){var a={};return void 0===$("#oculto").val()?a.indice=libreria.length:a.indice=Number($("#oculto").val()),a.isbn=$("#isbn").val(),a.titulo=$("#titulo").val(),a.autor=$("#autor").val(),a.anio=Number($("#anio").val()),a.editorial=$("#editorial").val(),a.iddb="",a}function formNoVacio(){var a=$("#isbn").val()+$("#titulo").val()+$("#autor").val()+$("#anio").val()+$("#editorial").val();return""===a.trim()?!1:!0}function comparaObj(a,i){var e,o,r=0;if(void 0!==i)for(o in a){if(r>=6)break;if(a[o]!==i[o]){e=!1;break}e=!0,r++}else e=!0;return e}function sweetConfirm(a){swal({title:"¿Nueva selección?",text:"Los datos modificados en el formulario se perderán",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Seleccionar",cancelButtonText:"Cancelar",closeOnConfirm:!0,closeOnCancel:!0},function(i){if(i?user=!0:user=!1,user){$("tr").removeClass("seleccionado"),$(".mensaje").html(""),$("input").css("border","1px solid black"),$(a).addClass("seleccionado");var e,o=[];for(e=1;6>=e;e++)o.push($(".seleccionado :nth-of-type("+e+")").text());$("#isbn").val(o[0]),$("#titulo").val(o[1]),$("#autor").val(o[2]),$("#anio").val(o[3]),$("#editorial").val(o[4]),$("#oculto").val(o[5])}})}function seleccionar(a){var i;if(-1!==a.getAttribute("class").indexOf("seleccionado"))$(a).removeClass("seleccionado"),limpiaForm(),chequeaBotones();else{var e=objFormulario();if(!comparaObj(e,libreria[e.indice])&&formNoVacio()?sweetConfirm(a):i=!0,i){$("tr").removeClass("seleccionado"),$(".mensaje").html(""),$("input").css("border","1px solid black"),$(a).addClass("seleccionado");var o,r=[];for(o=1;6>=o;o++)r.push($(".seleccionado :nth-of-type("+o+")").text());$("#isbn").val(r[0]),$("#titulo").val(r[1]),$("#autor").val(r[2]),$("#anio").val(r[3]),$("#editorial").val(r[4]),$("#oculto").val(r[5])}}chequeaBotones()}function alta(){$("#oculto").val(libreria.length);var a=validar(),i=compararisbn($("#isbn").val());a&&i?(nindice=libreria.length,libreria[nindice]=a,libreriaDB.push(a,function(){añadeIddb(libreria,nindice),actualizar(libreria),$(".pageSelector:last").click()})):(montaAlerta(),sweetAlert("Datos erróneos, corregir:",alertmensaje))}function modificar(){if(datomodificado=validar(),datomodificado)if(aindice=datomodificado.indice,datomodificado.iddb=libreria[aindice].iddb,libreria[aindice]=datomodificado,db.ref("libreria/"+libreria[aindice].iddb).set(datomodificado),busquedaactiva===!0){for(var a in busquedas)busquedas[a].indice==aindice&&(busquedas[a]=datomodificado);$(".seleccionado").html("<td>"+datomodificado.isbn+"</td><td>"+datomodificado.titulo+"</td><td>"+datomodificado.autor+"</td><td>"+datomodificado.anio+"</td><td>"+datomodificado.editorial+'</td><td class="sr-only">'+datomodificado.indice+"</td>"),$(".seleccionado").removeClass("seleccionado"),limpiaForm()}else $(".seleccionado").html("<td>"+datomodificado.isbn+"</td><td>"+datomodificado.titulo+"</td><td>"+datomodificado.autor+"</td><td>"+datomodificado.anio+"</td><td>"+datomodificado.editorial+'</td><td class="sr-only">'+datomodificado.indice+"</td>"),$(".seleccionado").removeClass("seleccionado"),limpiaForm();else{montaAlerta();sweetAlert("Datos erróneos, corregir:",alertmensaje)}chequeaBotones()}function borrar(){swal({title:"¿Está seguro?",text:"La entrada de la base de datos no se podrá recuperar",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, bórralo",cancelButtonText:"Cancelar",closeOnConfirm:!0,closeOnCancel:!0},function(a){if(a){var i,e=$("#oculto").val(),o=libreria[e].iddb;for(db.ref("libreria/"+o).remove(),libreria.splice(e,1),i=0;i<libreria.length;i++)libreria[i].indice=i;$(".seleccionado").remove(),limpiaForm()}})}function busqueda(){busquedas=[],busquedasaux=[];var a;$("#resultado").text("");var i=!1;$("#isbn").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#isbn").val(),abuscar("isbn",a)):busquedasactuales>0&&abuscarb("isbn",a)),$("#titulo").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#titulo").val(),abuscar("titulo",a)):busquedasactuales>0&&(a=$("#titulo").val(),abuscarb("titulo",a))),$("#autor").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#autor").val(),abuscar("autor",a)):busquedasactuales>0&&(a=$("#autor").val(),abuscarb("autor",a))),$("#anio").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#anio").val(),abuscar("anio",a)):busquedasactuales>0&&(a=$("#anio").val(),abuscarb("anio",a))),$("#editorial").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#editorial").val(),abuscar("editorial",a)):busquedasactuales>0&&(a=$("#editorial").val(),abuscarb("editorial",a))),actualizar(busquedas)}function abuscar(a,e){for(librosactuales=libreria.length,i=0;i<librosactuales;i++)-1!=libreria[i][a].toLowerCase().indexOf(e.toLowerCase())&&busquedas.push(libreria[i]);0===busquedas.length&&(sinencontrar=!0,$("#tableta tbody").append('<tr><td colspan="5" id="resultado" style="background-color: white;">No encontramos libros que coincidan con los valores introducidos</td></tr>'),$("#busqueda").text("Resultados de la búsqueda"),$("th").css("background-color","#66ffb3"))}function abuscarb(a,i){busquedasaux=[],busquedasactuales=busquedas.length;for(var e=0;e<busquedasactuales;e++)-1!=busquedas[e][a].toLowerCase().indexOf(i.toLowerCase())&&busquedasaux.push(busquedas[e]);busquedas=JSON.parse(JSON.stringify(busquedasaux)),0===busquedas.length&&($("#resultado").text("No encontramos libros que coincidan con los valores introducidos"),$("#busqueda").text("Resultados de la búsqueda"),$("th").css("background-color","#66ffb3"))}var libreria=[],busquedas=[],busquedasaux=[],arrmensajes=[],alertmensaje,numerodefilas,porpagina="8",arraymostrado=[],busquedaactiva=!1;Object.size=function(a){var i,e=0;for(i in a)a.hasOwnProperty(i)&&e++;return e};var db=firebase.database(),libreriaDB=db.ref("libreria");$(function(){function a(){swal({title:"¿Resetear Formulario?",text:"Los datos modificados en el formulario se perderán",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Resetear",cancelButtonText:"Cancelar",closeOnConfirm:!0,closeOnCancel:!0},function(a){a?user=!0:user=!1,user&&($(".seleccionado").removeClass("seleccionado"),limpiaForm())})}function i(){var i=objFormulario();!comparaObj(i,libreria[i.indice])&&formNoVacio()?a():limpiaForm()}var e=function(){$(".offline-ui").is(".offline-ui-down")?($(".icono").html('<i class="fa fa-exclamation-triangle" aria-hidden="true"></i>'),$(".icono").attr("title","Sin conexión de red")):$(".icono").html("")};setInterval(e,1e3),cargaLibreria(libreria),$("#btnUpDown").click(function(){$("#despUpDown").hasClass("fa fa-chevron-circle-up")?($("#despUpDown").removeClass("fa fa-chevron-circle-up"),$("#despUpDown").addClass("fa fa-chevron-circle-down"),$("#notabla").slideUp("slow")):($("#despUpDown").removeClass("fa fa-chevron-circle-down"),$("#despUpDown").addClass("fa fa-chevron-circle-up"),$("#notabla").slideDown("slow"))}),$("#isbn").bind("input change",validarIsbn),$("#isbn").blur(validarIsbn),$("#titulo").bind("input change",validarTitulo),$("#titulo").blur(validarTitulo),$("#autor").bind("input change",validarAutor),$("#autor").blur(validarAutor),$("#anio").bind("input change",validarAnio),$("#anio").blur(validarAnio),$("#editorial").bind("input change",validarEditorial),$("#editorial").blur(validarEditorial),$("#resetear").mouseover(function(){formNoVacio()||""!==$(".mensaje").html()?$("#resetear").removeClass("disabled"):$("#resetear").addClass("disabled")}),$("#anadir").click(function(){Boolean($(".seleccionado")[0])||alta()}),$("#buscar").click(function(){if(!Boolean($(".seleccionado")[0]))switch($("#buscar").text()){case"BUSCAR":formNoVacio()&&(busquedaactiva=!0,$("#buscar").text("VOLVER"),busqueda());break;case"VOLVER":$("#buscar").text("BUSCAR"),busquedaactiva=!1,actualizar(libreria)}}),$("#modificar").click(function(){Boolean($(".seleccionado")[0])&&modificar()}),$("#quitar").click(function(){Boolean($(".seleccionado")[0])&&borrar()}),$("#resetear").click(function(){$("#resetear").hasClass("disabled")||i()}),$(document).keyup(function(a){return 27==a.keyCode&&i(),13==a.keyCode?!1:void 0}),$("#filasPagina8").click(function(){porpagina=8,actualizar(arraymostrado)}),$("#filasPagina16").click(function(){porpagina=16,actualizar(arraymostrado)}),$("#filasPagina32").click(function(){porpagina=32,actualizar(arraymostrado)}),$("#filasPagina64").click(function(){porpagina=64,actualizar(arraymostrado)}),$("#filasPaginaAll").click(function(){porpagina="All",actualizar(arraymostrado)}),$(".filaspPagina span").click(function(){$(".filaspPagina span").removeClass("selectPaginas"),$(this).addClass("selectPaginas")})}),libreriaDB.on("child_changed",function(a){var i=a.val();cambioRemoto(i,Number(i.indice))}),libreriaDB.on("value",function(a){a.val();cargaLibreria(libreria)}),libreriaDB.on("child_removed",function(a){var i=a.val();libreria.splice(i.indice,1);for(var e=0;e<libreria.length;e++)libreria[e].indice=e});